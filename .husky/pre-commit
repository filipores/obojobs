npx lint-staged --allow-empty

# Skip code-simplifier if SKIP_SIMPLIFIER is set
if [ -n "$SKIP_SIMPLIFIER" ]; then
    exit 0
fi

# Get staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|py|go|rs|sh)$' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "üîß Running code-simplifier on staged changes..."

    # Get the actual diff of staged changes
    STAGED_DIFF=$(git diff --cached -- $STAGED_FILES)

    # Create file list for context
    FILE_LIST=$(echo "$STAGED_FILES" | tr '\n' ',' | sed 's/,$//')

    # Create prompt with diff context
    PROMPT="Review and simplify ONLY the changed code shown in this diff. Files: $FILE_LIST

DIFF:
$STAGED_DIFF"

    # Run code-simplifier via Claude CLI in non-interactive mode
    if claude -p "/code-simplifier $PROMPT" --dangerously-skip-permissions 2>/dev/null; then
        # Re-stage any changes made by the simplifier
        echo "$STAGED_FILES" | while read -r file; do
            if [ -f "$file" ]; then
                git add "$file"
            fi
        done
        echo "‚úÖ Code simplification complete"
    else
        echo "‚ö†Ô∏è  Code-simplifier skipped (Claude CLI not available or failed)"
    fi
fi
