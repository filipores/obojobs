name: CI

on:
  push:
    branches: [main, ralph/*]
  pull_request:
    branches: [main]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-json-report ruff mypy

      - name: Run ruff linter
        working-directory: ./backend
        run: |
          ruff check . --output-format=json > ruff-results.json || true
          ruff check . --output-format=github

      - name: Run mypy type checking
        working-directory: ./backend
        run: mypy . --config-file mypy.ini

      - name: Run backend tests with coverage
        working-directory: ./backend
        run: |
          pytest --cov=. --cov-report=term-missing --cov-report=xml --cov-fail-under=55 --json-report --json-report-file=test-results.json

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

      - name: Upload backend test artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: backend-test-results
          path: |
            backend/test-results.json
            backend/ruff-results.json
          retention-days: 7

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        # Allow up to 100 warnings (currently ~40 console.log statements)
        # Errors will still fail the build, warnings are logged but don't block
        run: |
          npm run lint -- --format json --output-file eslint-results.json --max-warnings=100 || true
          npm run lint -- --max-warnings=100
        continue-on-error: false

      - name: Run frontend tests with coverage
        working-directory: ./frontend
        run: npm run test:coverage -- --reporter=json --outputFile=test-results.json

      - name: Upload frontend test artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/test-results.json
            frontend/eslint-results.json
          retention-days: 7

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Run E2E tests
        working-directory: ./frontend
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:4173

      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: |
            frontend/playwright-report/
            frontend/test-results.json
          retention-days: 7

  ci-summary:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: always()
    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create CI summary
        run: |
          # Determine job results from workflow context
          BACKEND_RESULT="${{ needs.backend-tests.result }}"
          FRONTEND_RESULT="${{ needs.frontend-tests.result }}"
          E2E_RESULT="${{ needs.e2e-tests.result }}"

          # Determine overall status
          if [ "$BACKEND_RESULT" = "success" ] && [ "$FRONTEND_RESULT" = "success" ] && [ "$E2E_RESULT" = "success" ]; then
            OVERALL="passed"
          else
            OVERALL="failed"
          fi

          # Create ci-summary.json using jq for proper JSON formatting
          jq -n \
            --arg sha "${{ github.sha }}" \
            --arg overall "$OVERALL" \
            --arg backend "$BACKEND_RESULT" \
            --arg frontend "$FRONTEND_RESULT" \
            --arg e2e "$E2E_RESULT" \
            --arg run_id "${{ github.run_id }}" \
            --arg run_number "${{ github.run_number }}" \
            --arg ref "${{ github.ref }}" \
            --arg event "${{ github.event_name }}" \
            '{
              sha: $sha,
              overall: $overall,
              jobs: {
                "backend-tests": {
                  result: $backend,
                  artifacts: ["backend-test-results"]
                },
                "frontend-tests": {
                  result: $frontend,
                  artifacts: ["frontend-test-results"]
                },
                "e2e-tests": {
                  result: $e2e,
                  artifacts: ["playwright-report"]
                }
              },
              workflow: {
                run_id: $run_id,
                run_number: $run_number,
                ref: $ref,
                event: $event
              }
            }' > ci-summary.json

          # Pretty print for logs
          echo "=== CI Summary ==="
          cat ci-summary.json | jq .

          # List downloaded artifacts
          echo ""
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -name "*.json" | head -20

      - name: Upload CI summary
        uses: actions/upload-artifact@v6
        with:
          name: ci-summary
          path: ci-summary.json
          retention-days: 30

      - name: Post PR comment with results
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get job results
          BACKEND_RESULT="${{ needs.backend-tests.result }}"
          FRONTEND_RESULT="${{ needs.frontend-tests.result }}"
          E2E_RESULT="${{ needs.e2e-tests.result }}"

          # Determine overall status
          if [ "$BACKEND_RESULT" = "success" ] && [ "$FRONTEND_RESULT" = "success" ] && [ "$E2E_RESULT" = "success" ]; then
            OVERALL="‚úÖ CI Results: All checks passed"
          else
            OVERALL="‚ùå CI Results: Some checks failed"
          fi

          # Convert result to emoji
          emoji() {
            case "$1" in
              success) echo "‚úÖ" ;;
              failure) echo "‚ùå" ;;
              cancelled) echo "‚ö™" ;;
              skipped) echo "‚è≠Ô∏è" ;;
              *) echo "‚ùì" ;;
            esac
          }

          # Build comment body to a file to preserve formatting
          {
            echo "## $OVERALL"
            echo ""
            echo "| Job | Status | Result |"
            echo "|-----|--------|--------|"
            echo "| Backend Tests | $(emoji "$BACKEND_RESULT") | $BACKEND_RESULT |"
            echo "| Frontend Tests | $(emoji "$FRONTEND_RESULT") | $FRONTEND_RESULT |"
            echo "| E2E Tests | $(emoji "$E2E_RESULT") | $E2E_RESULT |"
            echo ""
            echo "**Commit:** \`${{ github.sha }}\`"
            echo "**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "<details>"
            echo "<summary>üìä Machine-readable results (JSON)</summary>"
            echo ""
            echo "\`\`\`json"
            cat ci-summary.json
            echo "\`\`\`"
            echo ""
            echo "</details>"
          } > comment.md

          # Post the comment
          gh pr comment "${{ github.event.pull_request.number }}" \
            --body-file comment.md \
            --repo "${{ github.repository }}"
