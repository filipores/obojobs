# Ralph Progress Log - obojobs
Started: Mon Jan 12 23:59:47 CET 2026

## Codebase Patterns

- **Model Registration**: Neue Models in `backend/models/__init__.py` registrieren und zu `__all__` hinzufügen
- **Relationships**: Back-populates in beiden Models definieren (z.B. User.email_accounts und EmailAccount.user)
- **Migrations**: Einfaches Python-Script Pattern mit upgrade(app) und downgrade(app) Funktionen
- **Encryption**: Fernet aus cryptography library für Token-Verschlüsselung, Key aus Environment Variable
- **OAuth Services**: Pattern für OAuth-Services in backend/services/ - get_authorization_url(), exchange_code_for_tokens(), refresh_access_token()
- **Route Registration**: Neue Blueprints in app.py importieren und mit register_blueprint() registrieren

---

## 2026-01-13 - EMAIL-001
- Implementiert: EmailAccount Model mit Fernet-Verschlüsselung für OAuth Tokens
- Geänderte Dateien:
  - backend/models/email_account.py (NEU)
  - backend/models/__init__.py
  - backend/models/user.py
  - backend/migrations/add_email_accounts.py (NEU)
  - backend/requirements.txt
- **Learnings:**
  - cryptography library muss zu requirements.txt hinzugefügt werden
  - EMAIL_ENCRYPTION_KEY muss als Environment Variable gesetzt sein
  - Token-Encryption nutzt Fernet.encrypt() / Fernet.decrypt()

---

## 2026-01-13 - EMAIL-002
- Implementiert: Gmail OAuth 2.0 Flow mit Authorization URL und Callback
- Geänderte Dateien:
  - backend/services/gmail_service.py (NEU)
  - backend/routes/email.py (NEU)
  - backend/app.py
  - backend/requirements.txt
- **Learnings:**
  - google-auth-oauthlib library für Google OAuth Flow
  - Flow.from_client_config() akzeptiert client config dict
  - Token-Refresh via POST zu oauth2.googleapis.com/token
  - User-Email via googleapis.com/oauth2/v2/userinfo Endpoint
  - OAuth State in Flask session für CSRF-Schutz
  - Scopes: gmail.send, userinfo.email, openid

---

## 2026-01-13 - EMAIL-003
- Implementiert: Outlook OAuth 2.0 Flow mit Microsoft Graph API
- Geänderte Dateien:
  - backend/services/outlook_service.py (NEU)
  - backend/routes/email.py (erweitert)
  - backend/requirements.txt
- **Learnings:**
  - msal library für Microsoft Authentication Library
  - ConfidentialClientApplication für OAuth mit client secret
  - get_authorization_request_url() für Auth URL generierung
  - acquire_token_by_authorization_code() für Token-Exchange
  - acquire_token_by_refresh_token() für Token-Refresh
  - Microsoft Graph API Endpoint für User-Info: /v1.0/me
  - Email-Adresse kommt von "mail" oder "userPrincipalName" Feld
  - Scopes: Mail.Send, User.Read (mit https://graph.microsoft.com/ Prefix)
  - Authority: https://login.microsoftonline.com/common für Multi-Tenant

---

## 2026-01-13 - EMAIL-004
- Implementiert: Email Provider Management UI in Settings-Seite
- Geänderte Dateien:
  - backend/routes/email.py (erweitert mit accounts endpoints)
  - frontend/src/pages/Settings.vue (neue Email-Sektion)
- **Learnings:**
  - GET /api/email/accounts für Liste verbundener Accounts
  - DELETE /api/email/accounts/<id> zum Trennen
  - OAuth Popup-Flow mit window.open() und polling für popup.closed
  - Provider-Icons mit Gmail/Outlook Farben (#DB4437, #0078D4)
  - Status-Badge für "Verbunden" Anzeige
  - Unused catch-Variablen müssen mit _ prefixed werden für ESLint

---

## 2026-01-13 - EMAIL-005
- Implementiert: Email Composer Modal in Applications-Seite
- Geänderte Dateien:
  - frontend/src/pages/Applications.vue (Email Composer Modal hinzugefügt)
- **Learnings:**
  - Email Composer als Modal in bestehender Applications-Seite integriert
  - Formularfelder: An (vorausgefüllt aus app.email), Betreff, Nachricht
  - Vorschau-Modus zeigt finale Email mit Von/An/Betreff und Anhänge
  - Template-Variablen (FIRMA, POSITION, ANSPRECHPARTNER, QUELLE) werden via replaceTemplateVariables() ersetzt
  - Account-Selector lädt verbundene Email-Konten via GET /api/email/accounts
  - Warning-Box wenn keine Accounts verbunden sind, mit Link zu Einstellungen
  - Attachment-Info zeigt automatisch angehängte PDFs (Anschreiben + Lebenslauf)
  - Senden-Button deaktiviert wenn keine Accounts/To/Subject - Versand in EMAIL-006

---

## 2026-01-13 - EMAIL-006
- Implementiert: Email Versand mit Attachments über Gmail und Outlook APIs
- Geänderte Dateien:
  - backend/routes/email.py (POST /api/email/send Endpoint)
  - backend/services/gmail_service.py (send_email Methode mit MIME)
  - backend/services/outlook_service.py (send_email Methode mit Graph API)
  - frontend/src/pages/Applications.vue (sendEmail Funktion)
- **Learnings:**
  - Gmail API: base64url-encoded MIME message via gmail.googleapis.com/gmail/v1/users/me/messages/send
  - Outlook API: JSON Payload via graph.microsoft.com/v1.0/me/sendMail mit fileAttachment
  - MIME Message Aufbau mit email.mime.multipart und email.mime.application
  - Attachment-Größenlimit (10MB) wird serverseitig geprüft
  - Automatische Anhänge: Anschreiben-PDF aus Application.pdf_path, Lebenslauf aus Document (doc_type='cv_pdf')
  - Graph API Statuscode 202 für erfolgreichen Versand (kein Body in Response)

---

## 2026-01-13 - EMAIL-007
- Implementiert: Sent Tracking & Status Update nach Email-Versand
- Geänderte Dateien:
  - backend/models/application.py (sent_at und sent_via Felder hinzugefügt)
  - backend/routes/email.py (Status-Update nach erfolgreichem Versand)
  - backend/migrations/add_application_sent_tracking.py (NEU)
  - frontend/src/pages/Applications.vue (Sent-Info Anzeige und Button-Text)
- **Learnings:**
  - to_dict() Methode muss aktualisiert werden wenn neue Felder zum Model hinzugefügt werden
  - datetime.utcnow() für konsistente UTC-Timestamps
  - SQLite ALTER TABLE für neue nullable Columns ist einfach
  - Button-Text kann mit ternärem Operator basierend auf sent_at gesetzt werden
  - Eigene CSS-Klasse (.detail-group-sent) für visuelles Highlighting des Versandstatus
