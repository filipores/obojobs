# Ralph Progress Log - obojobs
Started: Tue Jan 13 11:46:53 CET 2026

## Codebase Patterns

### Services Pattern
- Backend services are in `backend/services/`
- Services use class-based pattern with `__init__` for configuration
- Import config from `config.py` module: `from config import config`
- Config attributes accessed as `config.ATTRIBUTE_NAME`

### Frontend Composables
- Composables in `frontend/src/composables/`
- Named export function pattern: `export function useXxx() { ... }`
- Use `ref`, `readonly`, `computed` from Vue
- Singleton pattern for SDK instances (like Stripe)

### Environment Variables
- Backend: `.env` loaded via `python-dotenv` in config.py
- Frontend: Vite uses `VITE_` prefix, accessed via `import.meta.env.VITE_*`

### Middleware Pattern
- Middlewares in `backend/middleware/`
- Use `@wraps(fn)` from functools for decorator pattern
- Decorator stacking order: Auth decorators (jwt_required, api_key_required) BEFORE business logic decorators (check_subscription_limit)
- Access current_user via kwargs or fetch from JWT identity

### Subscription System
- Subscription limits defined in `backend/middleware/subscription_limit.py`: PLAN_LIMITS dict
- Usage tracking: User.applications_this_month, User.month_reset_at
- Monthly reset happens on first request after month changes (lazy reset)
- Use increment_application_count() after successful operations
- Use get_subscription_usage() to get plan/limit/used/remaining for responses

---

## 2026-01-13 - STRIPE-001

**Was implementiert wurde:**
- Stripe SDK Setup für Backend und Frontend

**Geänderte Dateien:**
- `backend/requirements.txt` - Added stripe>=7.0.0
- `backend/config.py` - Added STRIPE_* config variables
- `backend/.env.example` - Added Stripe environment variables
- `backend/services/stripe_service.py` - NEW: Stripe service class
- `frontend/package.json` - Added @stripe/stripe-js
- `frontend/.env.example` - NEW: VITE_STRIPE_PUBLISHABLE_KEY
- `frontend/src/composables/useStripe.js` - NEW: Vue composable for Stripe.js

**Learnings:**
- stripe Python package uses `stripe.api_key = key` for configuration (different from class-based init)
- Stripe.js uses `loadStripe()` async function that returns a Promise
- Frontend env vars in Vite need `VITE_` prefix

---

## 2026-01-13 - STRIPE-002

**Was implementiert wurde:**
- Subscription Model war bereits vollständig implementiert (von STRIPE-001 Session)

**Verifizierte Dateien:**
- `backend/models/subscription.py` - Subscription Model mit SubscriptionPlan und SubscriptionStatus Enums
- `backend/models/user.py` - stripe_customer_id Feld und subscription Relationship bereits vorhanden
- `backend/models/__init__.py` - Subscription, SubscriptionPlan, SubscriptionStatus exportiert
- `backend/migrations/add_subscription.py` - Migration für subscriptions Table und stripe_customer_id

**Acceptance Criteria:**
- ✅ Subscription Model (user_id, stripe_customer_id, stripe_subscription_id, plan, status, current_period_start, current_period_end, created_at)
- ✅ Plan-Enum: free, basic, pro
- ✅ Status-Enum: active, canceled, past_due, trialing
- ✅ User Model: stripe_customer_id und subscription Relationship (One-to-One)
- ✅ Migration vorhanden

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors
- build: Success

**Learnings:**
- Subscription verwendet unique=True auf user_id für One-to-One Relationship
- Model wurde bereits in vorheriger Session erstellt (Teil von STRIPE-001 Vorbereitung)

---

## 2026-01-13 - STRIPE-003

**Was implementiert wurde:**
- GET /api/subscriptions/plans Endpoint (bereits vorhanden, verifiziert)
- SUBSCRIPTION_PLANS Dictionary mit Free/Basic/Pro Plänen
- Stripe Price IDs aus Config

**Verifizierte Dateien:**
- `backend/routes/subscriptions.py` - Endpoint und Plan-Definitionen
- `backend/app.py` - Blueprint registriert unter /api/subscriptions

**Acceptance Criteria:**
- ✅ GET /api/subscriptions/plans - Listet verfügbare Pläne
- ✅ Pläne: Free (€0, 3 Bewerbungen/Monat), Basic (€9.99, 20), Pro (€19.99, unbegrenzt)
- ✅ Stripe Product IDs in Config (STRIPE_PRICE_BASIC, STRIPE_PRICE_PRO)
- ✅ Response enthält: plan_id, name, price, features[], limits

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors
- build: Success

**Learnings:**
- Endpoint bereits von vorheriger Session implementiert (STRIPE-001/002 Vorbereitung)
- get_plan_limits() Helper-Funktion für andere Routen verfügbar

---

## 2026-01-13 - STRIPE-004

**Was implementiert wurde:**
- POST /api/subscriptions/create-checkout Endpoint
- Stripe Customer Erstellung falls nicht vorhanden
- Frontend Composable für Subscription-Operationen
- Success Page für Stripe Checkout

**Geänderte/Neue Dateien:**
- `backend/routes/subscriptions.py` - create-checkout Endpoint hinzugefügt
- `frontend/src/pages/SubscriptionSuccess.vue` - NEW: Success Page nach Checkout
- `frontend/src/composables/useSubscription.js` - NEW: Composable für Subscription API calls
- `frontend/src/router/index.js` - Route /subscription/success hinzugefügt

**Acceptance Criteria:**
- ✅ POST /api/subscriptions/create-checkout - Erstellt Stripe Checkout Session
- ✅ Parameter: plan (basic/pro), success_url, cancel_url
- ✅ Erstellt Stripe Customer falls noch nicht vorhanden
- ✅ Speichert stripe_customer_id am User
- ✅ Frontend: Redirect zu Stripe Checkout (via useSubscription.startCheckout())
- ✅ Success Page nach Kauf (/subscription/success)
- ✅ Alle Tests grün (pytest: 175, npm test: 63)
- ✅ Linting OK (ruff, eslint)

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors (19 warnings for console.log)
- build: Success

**Learnings:**
- Stripe Checkout Session enthält {CHECKOUT_SESSION_ID} Placeholder für success_url
- useStripe.redirectToCheckout() benötigt nur session_id
- SubscriptionSuccess.vue zeigt Subscription-Details nach Webhook-Verarbeitung
- Git nicht verfügbar wegen Xcode-Lizenz-Problem (System-Issue)

---

## 2026-01-13 - STRIPE-005

**Was implementiert wurde:**
- POST /api/webhooks/stripe Endpoint für Stripe Webhook-Events
- Signature Verification mit STRIPE_WEBHOOK_SECRET
- Event Handler für: checkout.session.completed, customer.subscription.created/updated/deleted
- Subscription Model wird automatisch bei Webhook-Events aktualisiert
- Logging für alle eingehenden Webhook-Events

**Geänderte/Neue Dateien:**
- `backend/routes/webhooks.py` - NEW: Webhook Blueprint mit Stripe Handler
- `backend/app.py` - webhooks_bp Blueprint unter /api/webhooks registriert

**Acceptance Criteria:**
- ✅ POST /api/webhooks/stripe - Webhook Endpoint (public, kein JWT)
- ✅ Signature Verification mit stripe.Webhook.construct_event()
- ✅ Events: checkout.session.completed, customer.subscription.created, customer.subscription.updated, customer.subscription.deleted
- ✅ Subscription Model wird bei Events aktualisiert (Plan, Status, Period Dates)
- ✅ Logging für alle Webhook-Events (Received, Processed, Errors)
- ✅ Alle Tests grün (pytest: 175, npm test: 63)
- ✅ Linting OK (ruff, eslint)

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors (19 warnings for console.log)
- build: Success

**Learnings:**
- Webhook Endpoint muss public sein (kein JWT required) da Stripe direkt sendet
- StripeService.construct_webhook_event() nutzt STRIPE_WEBHOOK_SECRET für Signatur-Verifizierung
- Stripe Event-Objekte haben nested structure: event["data"]["object"]
- checkout.session.completed enthält subscription_id für neue Abos
- customer.subscription.deleted setzt User zurück auf free Plan
- _map_stripe_status() mapped Stripe Status wie "incomplete" zu unseren Enums
- Git nicht verfügbar wegen Xcode-Lizenz-Problem (System-Issue)

---

## 2026-01-13 - STRIPE-006

**Was implementiert wurde:**
- Feature Gating mit monatlichen Subscription-Limits
- Neuer Middleware/Decorator: check_subscription_limit()
- Automatischer Monthly Counter Reset
- Ersetzt das alte Credit-System in den Generate-Endpoints

**Geänderte/Neue Dateien:**
- `backend/models/user.py` - Neue Felder: applications_this_month, month_reset_at
- `backend/middleware/subscription_limit.py` - NEW: Subscription Limit Middleware
- `backend/routes/applications.py` - check_subscription_limit Decorator, increment_application_count(), get_subscription_usage()
- `backend/migrations/add_subscription_usage.py` - NEW: Migration für neue User-Felder

**Acceptance Criteria:**
- ✅ User Model: applications_this_month (Integer, default 0)
- ✅ User Model: month_reset_at (DateTime)
- ✅ Middleware/Decorator: check_subscription_limit()
- ✅ Free: Max 3 Bewerbungen/Monat, Basic: 20, Pro: unbegrenzt (-1)
- ✅ Bei Limit erreicht: 403 mit klarer Fehlermeldung (SUBSCRIPTION_LIMIT_REACHED)
- ✅ Counter wird am Monatsanfang zurückgesetzt (via _check_and_reset_monthly_counter)
- ✅ Alle Tests grün (pytest: 175, npm test: 63)
- ✅ Linting OK (ruff, eslint)

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed (1 auto-fixed)
- npm test: 63 tests passed
- eslint: 0 errors (19 warnings for console.log)
- build: Success

**Learnings:**
- Decorator-Stacking: @api_key_required / @jwt_required_custom MUSS vor @check_subscription_limit kommen
- Reset-Logik prüft ob month_reset_at < current_month_start (1. des Monats)
- PLAN_LIMITS Dictionary mit Enum-Keys ermöglicht einfache Plan-zu-Limit Zuordnung
- get_subscription_usage() liefert plan, limit, used, remaining, unlimited für Frontend-Display
- Alte Credits-Logik (credits_remaining -= 1) durch increment_application_count() ersetzt
- Response enthält jetzt "usage" statt "credits_remaining"
- Git nicht verfügbar wegen Xcode-Lizenz-Problem (System-Issue)

---

## 2026-01-13 - STRIPE-007

**Was implementiert wurde:**
- Billing Portal & UI für Subscription-Verwaltung
- POST /api/subscriptions/portal Endpoint
- GET /api/subscriptions/current Endpoint
- Neue SubscriptionView.vue Page
- useSubscription Composable erweitert

**Geänderte/Neue Dateien:**
- `backend/routes/subscriptions.py` - Neue Endpoints: /portal und /current
- `frontend/src/pages/SubscriptionView.vue` - NEW: Vollständige Subscription Management Page
- `frontend/src/composables/useSubscription.js` - Erweitert: fetchCurrentSubscription(), openBillingPortal()
- `frontend/src/router/index.js` - Neue Route /subscription

**Acceptance Criteria:**
- ✅ Neue View: SubscriptionView.vue
- ✅ Zeigt: Aktueller Plan (mit Badge), Nutzung (X/Y mit Progress Bar), nächste Abrechnung
- ✅ POST /api/subscriptions/portal - Erstellt Stripe Portal Session
- ✅ Button: 'Abo verwalten' → Stripe Customer Portal
- ✅ Upgrade/Downgrade: Buttons für Basic/Pro Checkout, Vergleich aller Pläne
- ✅ Alle Tests grün (pytest: 175, npm test: 63)
- ✅ Linting OK (ruff: passed, eslint: 0 errors, 19 warnings)

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors (19 warnings for console.log)
- build: Success

**Learnings:**
- StripeService.create_portal_session() war bereits implementiert (aus STRIPE-001)
- /current Endpoint nutzt get_subscription_usage() aus middleware
- Frontend-Pattern: Composables mit async functions und ref states
- Page Design folgt Settings.vue Pattern mit zen-card, section-header etc.
- Git nicht verfügbar wegen Xcode-Lizenz-Problem (System-Issue)

---

## 2026-01-13 - STRIPE-008

**Was implementiert wurde:**
- Entfernung des Legacy Payment Systems (PayPal & Credits)
- Migration von Credits zu Subscription-basierter Nutzung
- UI Updates für Subscription statt Credits

**Gelöschte Dateien:**
- `backend/routes/payments.py` - PayPal payment routes
- `backend/services/paypal_service.py` - PayPal service
- `backend/models/purchase.py` - Purchase model
- `frontend/src/pages/BuyCredits.vue` - Credits kaufen Page
- `frontend/src/pages/PaymentSuccess.vue` - PayPal success page

**Geänderte Dateien:**
- `backend/app.py` - payments_bp Blueprint entfernt
- `backend/models/__init__.py` - Purchase Model Export entfernt
- `backend/models/user.py` - credits_remaining, credits_max, total_credits_purchased Felder und purchases Relationship entfernt
- `backend/config.py` - PayPal config und CREDIT_PACKAGES entfernt
- `backend/routes/stats.py` - Credits durch get_subscription_usage() ersetzt
- `backend/services/auth_service.py` - credits_remaining/credits_max Parameter bei User-Erstellung entfernt
- `frontend/src/router/index.js` - /buy-credits und /payment/success Routes entfernt
- `frontend/src/App.vue` - Credits-Display durch Subscription-Display ersetzt
- `frontend/src/pages/Dashboard.vue` - Credits-Card durch Subscription-Card ersetzt
- `frontend/src/pages/Settings.vue` - Credits-Anzeige durch Plan-Anzeige ersetzt
- `frontend/src/pages/NewApplication.vue` - Credits-Info durch Usage-Info ersetzt
- `backend/tests/conftest.py` - credits_remaining/credits_max aus test_user entfernt
- `backend/tests/test_password_reset.py`, `test_email_verification.py`, `test_auth.py` - Credits-Parameter entfernt
- `AGENTS.md` - PayPal/Credits Referenzen durch Stripe/Subscription ersetzt

**Acceptance Criteria:**
- ✅ Lösche backend/routes/payments.py
- ✅ Lösche backend/services/paypal_service.py
- ✅ Lösche Purchase Model & Migration
- ✅ User Model: credits_remaining, credits_max, total_credits_purchased entfernen
- ✅ Frontend: BuyCreditsView.vue entfernen
- ✅ Alle Referenzen auf Credits durch Subscription ersetzen
- ✅ Dashboard zeigt Subscription-Nutzung statt Credits
- ✅ Alle Tests grün (pytest: 175, npm test: 63)
- ✅ Linting OK (ruff: passed, eslint: 0 errors)

**Quality Checks:**
- pytest: 175 tests passed
- ruff: All checks passed
- npm test: 63 tests passed
- eslint: 0 errors (15 warnings for console.log)
- build: Success

**Learnings:**
- Stats-Endpoint gibt jetzt "usage" statt "credits_remaining" zurück
- Frontend getPlanLabel() für Plan-Anzeige in Navigation
- NewApplication Error Handling: 403 + error_code SUBSCRIPTION_LIMIT_REACHED
- Test-Fixtures müssen bei Model-Änderungen aktualisiert werden
- Git nicht verfügbar wegen Xcode-Lizenz-Problem (System-Issue)

---
