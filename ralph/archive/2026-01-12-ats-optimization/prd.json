{
  "project": "obojobs",
  "branchName": "ralph/email-integration",
  "description": "Email-Versand Integration - Gmail/Outlook OAuth für direkten Bewerbungsversand aus der App",
  "userStories": [
    {
      "id": "EMAIL-001",
      "title": "OAuth Token Storage Model",
      "description": "Datenbank-Model und Verschlüsselung für OAuth Tokens",
      "acceptanceCriteria": [
        "Neues Model: EmailAccount (user_id, provider, email, access_token_encrypted, refresh_token_encrypted, token_expires_at, created_at)",
        "Fernet-Verschlüsselung für Tokens (cryptography library)",
        "Encryption Key aus Environment Variable (EMAIL_ENCRYPTION_KEY)",
        "Helper-Funktionen: encrypt_token(), decrypt_token()",
        "Migration für neues Model",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 1,
      "passes": false,
      "notes": "cryptography bereits in requirements.txt oder hinzufügen"
    },
    {
      "id": "EMAIL-002",
      "title": "Gmail OAuth 2.0 Flow",
      "description": "Google OAuth Integration für Gmail-Zugriff",
      "acceptanceCriteria": [
        "Neuer Service: backend/services/gmail_service.py",
        "GET /api/email/gmail/auth-url - Generiert OAuth Authorization URL",
        "GET /api/email/gmail/callback - Verarbeitet OAuth Callback, speichert Tokens",
        "Scopes: gmail.send, userinfo.email",
        "Environment Variables: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI",
        "Token-Refresh wenn abgelaufen",
        "Fehlerbehandlung für OAuth-Fehler",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 2,
      "passes": false,
      "notes": "google-auth-oauthlib library verwenden"
    },
    {
      "id": "EMAIL-003",
      "title": "Outlook OAuth 2.0 Flow",
      "description": "Microsoft Graph API Integration für Outlook-Zugriff",
      "acceptanceCriteria": [
        "Neuer Service: backend/services/outlook_service.py",
        "GET /api/email/outlook/auth-url - Generiert OAuth Authorization URL",
        "GET /api/email/outlook/callback - Verarbeitet OAuth Callback, speichert Tokens",
        "Scopes: Mail.Send, User.Read",
        "Environment Variables: MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET, MICROSOFT_REDIRECT_URI",
        "Token-Refresh wenn abgelaufen",
        "Fehlerbehandlung für OAuth-Fehler",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 3,
      "passes": false,
      "notes": "msal library für Microsoft Authentication"
    },
    {
      "id": "EMAIL-004",
      "title": "Email Provider Management UI",
      "description": "Frontend für Verbinden/Trennen von Email-Accounts",
      "acceptanceCriteria": [
        "Neue Sektion in Settings-Seite: 'Email-Konto verbinden'",
        "Buttons: 'Mit Gmail verbinden', 'Mit Outlook verbinden'",
        "GET /api/email/accounts - Liste verbundener Accounts",
        "DELETE /api/email/accounts/<id> - Account trennen",
        "Anzeige: Verbundene Email-Adresse, Provider-Icon",
        "Status-Anzeige: Verbunden/Nicht verbunden",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 4,
      "passes": false,
      "notes": "OAuth Popup-Flow oder Redirect-Flow"
    },
    {
      "id": "EMAIL-005",
      "title": "Email Composer",
      "description": "UI zum Verfassen und Vorschau von Bewerbungs-Emails",
      "acceptanceCriteria": [
        "Neue View: EmailComposerView.vue (oder Modal in ApplicationsView)",
        "Felder: An (vorausgefüllt aus Application), Betreff (vorausgefüllt), Nachricht (vorausgefüllt)",
        "Vorschau-Modus: Zeigt finale Email",
        "Template-Variablen werden ersetzt (FIRMA, POSITION, etc.)",
        "Auswahl welcher verbundener Account zum Senden verwendet wird",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Betreff und Email-Text aus Application Model nutzen"
    },
    {
      "id": "EMAIL-006",
      "title": "Email Versand mit Attachments",
      "description": "Backend-Logik für Email-Versand mit Anhängen",
      "acceptanceCriteria": [
        "POST /api/email/send - Sendet Email über verbundenen Account",
        "Parameter: application_id, email_account_id, subject, body, attachments[]",
        "Automatische Anhänge: Generiertes PDF (Anschreiben), Lebenslauf",
        "Gmail: Verwendet Gmail API (messages.send mit MIME)",
        "Outlook: Verwendet Microsoft Graph API (/me/sendMail)",
        "Max Attachment Size: 10MB total",
        "Fehlerbehandlung: Token abgelaufen, Sendefehler",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 6,
      "passes": false,
      "notes": "MIME Message mit email.mime library erstellen"
    },
    {
      "id": "EMAIL-007",
      "title": "Sent Tracking & Status Update",
      "description": "Bewerbungsstatus nach Versand aktualisieren",
      "acceptanceCriteria": [
        "Application Model: Neues Feld 'sent_at' (DateTime, nullable)",
        "Application Model: Neues Feld 'sent_via' (String, nullable - 'gmail'/'outlook')",
        "Nach erfolgreichem Versand: Status automatisch auf 'versendet'",
        "sent_at wird gesetzt",
        "UI zeigt 'Gesendet am X via Gmail/Outlook' in Application-Details",
        "Versand-Button wird zu 'Erneut senden' nach erstem Versand",
        "Alle Tests grün (pytest, npm test)",
        "Linting OK (ruff, eslint)"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Migration für neue Felder in Application Model"
    }
  ]
}
