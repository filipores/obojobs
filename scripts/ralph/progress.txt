# Ralph Progress Log - obojobs
Started: 2025-01-12

## Codebase Patterns

### Frontend (Vue.js 3 + Vite)
- Entry Point: `frontend/src/main.js`
- Router: `frontend/src/router/index.js`
- API Client: `frontend/src/api/client.js` (Axios + JWT Interceptor)
- Auth Store: `frontend/src/store/auth.js` (localStorage-based)
- Komponenten: `frontend/src/components/`
- Seiten: `frontend/src/pages/`
- Composables: `frontend/src/composables/`
- Styles: `frontend/src/assets/styles.css` (Japanese Design System)
- Dev Server: Port 3000, Proxy `/api` → `http://127.0.0.1:5001`

### Backend (Flask + SQLAlchemy)
- Entry Point: `backend/app.py`
- Config: `backend/config.py`
- Models: `backend/models/` (User, Document, Template, Application, APIKey, Purchase)
- Routes: `backend/routes/` (auth, documents, templates, applications, api_keys, payments, stats)
- Services: `backend/services/` (generator, api_client, pdf_handler, web_scraper, paypal_service)
- Middleware: `backend/middleware/` (jwt_required, api_key_required)
- Server Port: 5001
- Database: SQLite (dev) at `backend/instance/obojobs.db`

### API Response Format
```json
// Standard Success (most endpoints)
{ "success": true, "data": {...}, "message": "..." }
// Standard Error
{ "success": false, "error": "Fehlermeldung" }
// Auth Login Response (direct format)
{ "access_token": "...", "refresh_token": "...", "user": {...} }
// Auth Register Response
{ "message": "...", "user": {...} }
```

### Authentication
- JWT Token in `Authorization: Bearer {token}` Header
- Token expires: 1 hour (access), 7 days (refresh)
- API Keys: `X-API-Key` Header for extension

### Template Variablen
- `{{FIRMA}}` - Firmenname
- `{{POSITION}}` - Stellenbezeichnung
- `{{ANSPRECHPARTNER}}` - Kontaktperson
- `{{QUELLE}}` - Stellenquelle
- `{{EINLEITUNG}}` - AI-generierte Einleitung

### Status-Werte (deutsch)
- erstellt, versendet, antwort_erhalten, absage, zusage

### Dokument-Typen
- lebenslauf, arbeitszeugnis, anschreiben

### File Storage
- Uploads: `backend/uploads/user_{id}/documents/`
- Generated PDFs: `backend/uploads/user_{id}/pdfs/`

### Limits
- Rate Limiting: 200/hour, 50/minute
- PDF Upload: max 10MB
- Template: max 500KB
- Default Credits: 5 per new user

## Key Files
- `backend/app.py` - Flask App Entry
- `backend/services/generator.py` - BewerbungsGenerator (Haupt-Logik)
- `backend/services/api_client.py` - Claude API Integration
- `frontend/src/App.vue` - Vue App Entry
- `frontend/src/api/client.js` - HTTP Client mit Interceptors
- `frontend/src/composables/useTemplateParser.js` - Template Parsing

## Gotchas
- Frontend nutzt Vite Proxy für `/api/*` Calls
- Backend muss auf Port 5001 laufen
- SQLAlchemy Models müssen mit `db.session.commit()` gespeichert werden
- JWT Errors (401/422) → Frontend macht automatisch Logout
- Credits werden in `User.credits_remaining` getracked

### Testing (Backend)
- Tests in `backend/tests/`
- Fixtures in `backend/tests/conftest.py`
- Test-DB: SQLite in-memory (`:memory:`)
- Run: `cd backend && source venv/bin/activate && pytest`
- Important: Return user data from fixtures as dict, not ORM object (avoids detached session issues)

### Linting (Backend)
- Tool: Ruff (schneller Python Linter + Formatter)
- Config: `backend/ruff.toml`
- Check: `cd backend && source venv/bin/activate && ruff check .`
- Format: `cd backend && source venv/bin/activate && ruff format .`
- Auto-fix: `cd backend && source venv/bin/activate && ruff check --fix .`

### Testing (Frontend)
- Tool: Vitest (schneller Test-Runner für Vite)
- Config: `frontend/vitest.config.js`
- Tests in: `frontend/src/__tests__/`
- Run: `cd frontend && npm test`
- Watch: `cd frontend && npm run test:watch`
- Test environment: jsdom (Browser-like)

### Linting (Frontend)
- Tool: ESLint 9 mit eslint-plugin-vue (Flat Config)
- Config: `frontend/eslint.config.js`
- Check: `cd frontend && npm run lint`
- Auto-fix: `cd frontend && npm run lint:fix`
- Rules: Vue 3 essential + JS recommended

---
## Iteration Log

---
## 2026-01-12 - INFRA-001
- **Story**: Backend: pytest Setup
- **Implementiert**:
  - pytest und pytest-cov zu requirements.txt hinzugefügt
  - `backend/tests/` Verzeichnis mit `__init__.py`, `conftest.py`, `test_setup.py` erstellt
  - Fixtures: `app`, `client`, `test_user`, `auth_token`, `auth_headers`
  - `backend/pytest.ini` mit Testkonfiguration
- **Geänderte Dateien**:
  - `backend/requirements.txt` (pytest deps)
  - `backend/pytest.ini` (neu)
  - `backend/tests/__init__.py` (neu)
  - `backend/tests/conftest.py` (neu)
  - `backend/tests/test_setup.py` (neu)
- **Learnings**:
  - Environment vars müssen VOR app import gesetzt werden
  - User-Fixtures sollten Dict zurückgeben statt ORM-Objekt (detached session)
  - Exit code 5 = "no tests collected" (nicht Fehler, nur leeres Testverzeichnis)

---
## 2026-01-12 - INFRA-002
- **Story**: Backend: Health & Auth Tests
- **Implementiert**:
  - `test_health.py` mit Health-Endpoint Test
  - `test_auth.py` mit Auth-Tests (Register + Login)
  - Korrektur der `auth_token` Fixture (nutzt `access_token` statt `data['data']['token']`)
- **Geänderte Dateien**:
  - `backend/tests/test_health.py` (neu)
  - `backend/tests/test_auth.py` (neu)
  - `backend/tests/conftest.py` (auth_token Fixture Fix)
- **Learnings**:
  - Login Response Format: `{ access_token, refresh_token, user }` (ohne wrapper `data` object)
  - pytest Test-Klassen helfen bei Gruppierung: `class TestRegister`, `class TestLogin`

---
## 2026-01-12 - INFRA-003
- **Story**: Backend: Ruff Linter Setup
- **Implementiert**:
  - `ruff>=0.8.0` zu requirements.txt hinzugefügt
  - `backend/ruff.toml` mit Konfiguration:
    - Line length: 120
    - Target: Python 3.11
    - Excludes: migrations/, __pycache__/, venv/, instance/
    - Rules: E, W, F, I, B, C4, UP (pycodestyle, pyflakes, isort, bugbear, comprehensions, pyupgrade)
- **Geänderte Dateien**:
  - `backend/requirements.txt` (ruff hinzugefügt)
  - `backend/ruff.toml` (neu)
- **Learnings**:
  - Ruff kombiniert flake8 + black + isort in einem schnellen Tool
  - `ruff check --fix .` für automatische Fixes
  - `ruff format .` für Code-Formatierung
  - E402 (module level import not at top) erscheint bei `models/__init__.py` Pattern - muss in INFRA-004 adressiert werden

---
## 2026-01-12 - INFRA-004
- **Story**: Backend: Bestehenden Code lint-konform machen
- **Implementiert**:
  - `ruff check --fix .` ausgeführt (67 automatische Fixes)
  - Manuelle Fixes für verbleibende 12 Errors:
    - `app.py`: Unused variable `jwt` → entfernt (JWTManager wird inline initialisiert)
    - `models/__init__.py`: E402 → `# noqa: E402` Kommentare (intentional late imports)
    - `services/api_client.py`: B904 → `raise ... from e` für Exception-Chaining
    - `services/api_client.py`: F841 → Unused `attachments_text` entfernt
    - `services/web_scraper.py`: B904 → `raise ... from e` für Exception-Chaining
  - `ruff format .` formatiert 30 Dateien
- **Geänderte Dateien**:
  - `backend/app.py`
  - `backend/config.py`
  - `backend/models/__init__.py`
  - `backend/models/*.py` (alle 6 Model-Dateien)
  - `backend/routes/*.py` (alle 7 Route-Dateien)
  - `backend/services/*.py` (alle 6 Service-Dateien)
  - `backend/middleware/*.py` (2 Dateien)
  - `backend/tests/*.py` (4 Test-Dateien)
  - `backend/migrations/init_db.py`
- **Learnings**:
  - `# noqa: E402` ist der richtige Weg für intentionale late imports (wie in `models/__init__.py`)
  - B904: Exception-Chaining mit `raise ... from e` bewahrt den Original-Traceback
  - Ruff-Format nutzt Double-Quotes statt Single-Quotes (konsistent)

---
## 2026-01-12 - INFRA-005
- **Story**: Frontend: Vitest Setup
- **Implementiert**:
  - vitest, @vue/test-utils, jsdom zu devDependencies hinzugefügt
  - `frontend/vitest.config.js` mit Vue-Plugin und jsdom environment
  - `frontend/src/__tests__/` Verzeichnis erstellt
  - `test` und `test:watch` Scripts in package.json
  - Setup-Test (`setup.test.js`) zur Verifizierung
- **Geänderte Dateien**:
  - `frontend/package.json` (deps + scripts)
  - `frontend/vitest.config.js` (neu)
  - `frontend/src/__tests__/setup.test.js` (neu)
- **Learnings**:
  - Vitest nutzt separate config (`vitest.config.js`) um Konflikte mit vite.config.js zu vermeiden
  - `globals: true` ermöglicht `describe`, `it`, `expect` ohne imports
  - jsdom environment simuliert Browser für Vue Component Tests
  - Node.js 19.7.0 zeigt Warnings für Vite/Vitest (erwartet >=20), funktioniert aber

---
## 2026-01-12 - INFRA-006
- **Story**: Frontend: Erste Component Tests
- **Implementiert**:
  - Tests für `Toast.vue` Komponente erstellt
  - Rendering Tests: leerer Container, Toast hinzufügen, Icons für alle Typen
  - Interaktions Tests: Close-Button, Auto-Remove nach Duration, Multiple Toasts
- **Geänderte Dateien**:
  - `frontend/src/__tests__/Toast.test.js` (neu)
- **Learnings**:
  - `vi.useFakeTimers()` beeinflusst `Date.now()` - bei mehreren Toasts mit gleicher Zeit bekommen sie gleiche IDs
  - `vi.advanceTimersByTime(1)` zwischen adds hilft, unterschiedliche IDs zu erzeugen
  - `wrapper.vm.add()` ruft exposed Methoden der Komponente direkt auf
  - `wrapper.vm.$nextTick()` nach State-Änderungen warten für DOM-Update

---
## 2026-01-12 - INFRA-007
- **Story**: Frontend: ESLint Setup
- **Implementiert**:
  - eslint und eslint-plugin-vue zu devDependencies hinzugefügt
  - `frontend/eslint.config.js` mit ESLint Flat Config (neuer Standard)
  - Vue 3 essential rules (weniger strikt als recommended, fokussiert auf echte Fehler)
  - Browser globals (window, document, console, etc.) konfiguriert
  - DOM API globals (Node, NodeFilter, etc.) konfiguriert
  - `lint` und `lint:fix` Scripts in package.json
- **Geänderte Dateien**:
  - `frontend/package.json` (deps + scripts)
  - `frontend/eslint.config.js` (neu)
- **Learnings**:
  - ESLint 9 nutzt "Flat Config" Format (Array statt Object)
  - `eslint-plugin-vue` bietet verschiedene Rule-Sets: essential < strongly-recommended < recommended
  - `flat/essential` ist besser für bestehenden Code (weniger Style-Rules, mehr Error-Detection)
  - Browser globals müssen manuell definiert werden (kein `env: { browser: true }` in Flat Config)
  - Node 19.7.0 funktioniert trotz Engine-Warnings (erwartet >=20)
