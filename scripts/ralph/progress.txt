# Ralph Progress Log - obojobs
Started: Mon Jan 12 23:59:47 CET 2026

## Codebase Patterns

- **Model Registration**: Neue Models in `backend/models/__init__.py` registrieren und zu `__all__` hinzufügen
- **Relationships**: Back-populates in beiden Models definieren (z.B. User.email_accounts und EmailAccount.user)
- **Migrations**: Einfaches Python-Script Pattern mit upgrade(app) und downgrade(app) Funktionen
- **Encryption**: Fernet aus cryptography library für Token-Verschlüsselung, Key aus Environment Variable
- **OAuth Services**: Pattern für OAuth-Services in backend/services/ - get_authorization_url(), exchange_code_for_tokens(), refresh_access_token()
- **Route Registration**: Neue Blueprints in app.py importieren und mit register_blueprint() registrieren

---

## 2026-01-13 - EMAIL-001
- Implementiert: EmailAccount Model mit Fernet-Verschlüsselung für OAuth Tokens
- Geänderte Dateien:
  - backend/models/email_account.py (NEU)
  - backend/models/__init__.py
  - backend/models/user.py
  - backend/migrations/add_email_accounts.py (NEU)
  - backend/requirements.txt
- **Learnings:**
  - cryptography library muss zu requirements.txt hinzugefügt werden
  - EMAIL_ENCRYPTION_KEY muss als Environment Variable gesetzt sein
  - Token-Encryption nutzt Fernet.encrypt() / Fernet.decrypt()

---

## 2026-01-13 - EMAIL-002
- Implementiert: Gmail OAuth 2.0 Flow mit Authorization URL und Callback
- Geänderte Dateien:
  - backend/services/gmail_service.py (NEU)
  - backend/routes/email.py (NEU)
  - backend/app.py
  - backend/requirements.txt
- **Learnings:**
  - google-auth-oauthlib library für Google OAuth Flow
  - Flow.from_client_config() akzeptiert client config dict
  - Token-Refresh via POST zu oauth2.googleapis.com/token
  - User-Email via googleapis.com/oauth2/v2/userinfo Endpoint
  - OAuth State in Flask session für CSRF-Schutz
  - Scopes: gmail.send, userinfo.email, openid

---

## 2026-01-13 - EMAIL-003
- Implementiert: Outlook OAuth 2.0 Flow mit Microsoft Graph API
- Geänderte Dateien:
  - backend/services/outlook_service.py (NEU)
  - backend/routes/email.py (erweitert)
  - backend/requirements.txt
- **Learnings:**
  - msal library für Microsoft Authentication Library
  - ConfidentialClientApplication für OAuth mit client secret
  - get_authorization_request_url() für Auth URL generierung
  - acquire_token_by_authorization_code() für Token-Exchange
  - acquire_token_by_refresh_token() für Token-Refresh
  - Microsoft Graph API Endpoint für User-Info: /v1.0/me
  - Email-Adresse kommt von "mail" oder "userPrincipalName" Feld
  - Scopes: Mail.Send, User.Read (mit https://graph.microsoft.com/ Prefix)
  - Authority: https://login.microsoftonline.com/common für Multi-Tenant

---

## 2026-01-13 - EMAIL-004
- Implementiert: Email Provider Management UI in Settings-Seite
- Geänderte Dateien:
  - backend/routes/email.py (erweitert mit accounts endpoints)
  - frontend/src/pages/Settings.vue (neue Email-Sektion)
- **Learnings:**
  - GET /api/email/accounts für Liste verbundener Accounts
  - DELETE /api/email/accounts/<id> zum Trennen
  - OAuth Popup-Flow mit window.open() und polling für popup.closed
  - Provider-Icons mit Gmail/Outlook Farben (#DB4437, #0078D4)
  - Status-Badge für "Verbunden" Anzeige
  - Unused catch-Variablen müssen mit _ prefixed werden für ESLint
